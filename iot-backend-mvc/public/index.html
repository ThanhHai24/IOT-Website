<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="assets/css/style.css">
    <title>IoT Dashboard - Device Monitoring & Control</title>
</head>
<body>
    <!-- SideBar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">IOT Dashboard</div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" href="index.html">
                    <span class="nav-icon"><i class="ri-home-7-line"></i></span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sensordata.html">
                    <span class="nav-icon"><i class="ri-sensor-line"></i></span>
                    <span>Sensor Data</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="devices.html">
                    <span class="nav-icon"><i class="ri-lightbulb-line"></i></span>
                    <span>Devices</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
     <div class="main-content">
        <!-- TopBar -->
        <div class="header">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
            <div class="profile-section" onclick="openProfileModal()">
                <div class="profile-avatar"><img src="assets/images/Anhthe.jpg" alt=""></div>
                <span class="profile-name">Nông Thanh Hải</span>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <!-- Sensor Cards -->
            <div class="dashboard-grid">
                <div class="card sensor-card">
                    <div class="sensor-info">
                        <h3>Temperature</h3>
                        <div class="sensor-value" id="temp">25.5<span>°C</span></div>
                    </div>
                    <div class="sensor-icon temp-icon"><i class="bi bi-thermometer icon-bg"></i></div>
                </div>
                <div class="card sensor-card">
                    <div class="sensor-info">
                        <h3>Humidity</h3>
                        <div class="sensor-value" id="humid">65<span>%</span></div>
                    </div>
                    <div class="sensor-icon humid-icon"><i class="bi bi-droplet humid-icon"></i></div>
                </div>
                <div class="card sensor-card">
                    <div class="sensor-info">
                        <h3>Light Level</h3>
                        <div class="sensor-value" id="light">750 <span>lux</span></div>
                    </div>
                    <div class="sensor-icon light-icon"><i class="bi bi-brightness-high-fill light-icon"></i></div>
                </div>
            </div>

            <!-- Device Controls -->
            <div class="dashboard-grid">
                <div class="card device-card" id="card-light">
                    <div class="device-card-name">
                        <div class="device-icon">
                            <i id="icon-light" class="bi bi-lightbulb-fill"></i>
                        </div>
                        <div class="device-info">
                            <h3>Light Bulb</h3>
                            <span class="device-status" id="status-light"></span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleDevice('light', this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="card device-card" id="card-fan">
                    <div class="device-card-name">
                        <div class="device-icon">
                            <i id="icon-fan" class="fa-solid fa-fan"></i>
                        </div>
                        <div class="device-info">
                            <h3>Fan</h3>
                            <span class="device-status" id="status-fan"></span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleDevice('fan', this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="card device-card" id="card-ac">
                    <div class="device-card-name">
                        <div class="device-icon">
                            <i id="icon-ac" class="bi bi-snow2">   
                            </i>
                        </div>
                        <div class="device-info">
                            <h3>Air Conditioner</h3>
                            <span class="device-status" id="status-ac"></span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" onchange="toggleDevice('ac', this)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Sensor Readings Over Time</h3>
                <canvas id="chartLine" height="120"></canvas>
                <div id="chart"></div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Thông tin cá nhân</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="profile-modal-content">
                <div class="profile-modal-avatar"><img src="assets/images/Anhthe.jpg" alt=""></div>
                <div class="profile-info">
                    <h2>Nông Thanh Hải</h2>
                    <div class="profile-info-grid">
                        <div class="personal-information">
                            <h3 style="text-align: center;">Thông tin cá nhân</h3>
                            <p><strong>Ngày Sinh:</strong> 05/09/2004</p>
                            <p><strong>Địa Chỉ:</strong> Thái Nguyên, Việt Nam</p>
                            <p><strong>Số Điện Thoại:</strong> 0969175272</p>
                            <p><strong>Email:</strong> nthanhhai594@gmail.com</p>
                        </div>
                        <div class="school-infomation">
                            <h3 style="text-align: center;">Thông tin học tập</h3>
                            <p><strong>Mã Sinh Viên:</strong> B22DCCN264</p>
                            <p><strong>Lớp:</strong> HTTT06</p>
                            <p><strong>Trường:</strong> Học Viện Công Nghệ Bưu Chính Viễn Thông</p>
                            <p><strong>Chuyên Ngành:</strong> Công nghệ thông tin</p>
                            
                        </div>
                    </div>
                    
                </div>
                <div class="profile-links">
                    <a href="https://github.com/ThanhHai24/IOT-Website"><img src="assets/images/github.jpg" alt=""></a>
                    <a href="https://docs.google.com/document/d/18-zN4Ud4orReVs2r7J5CfNzvaIeG-Kev/edit"><img src="assets/images/PDF.png" alt=""></a>
                    <a href="http://localhost:3000/api-docs"><img src="assets/images/Swagger.png"  alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <!-- Profile modal JS -->
    <script src="assets/js/profilemodal.js"></script>
    <!-- SensorIcon -->
    <script src="assets/js/sensoricon.js"></script>
    <!-- Chart.js libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        /** =============================
         *  A) Khai báo chung
         *  ============================= */
        const socket = io();

        // Map tên UI -> id thiết bị trong DB (seed: 1,2,3)
        const DEVICE_MAP = {
        light: { id: 1, label: 'Light Bulb' },
        fan:   { id: 2, label: 'Fan' },
        ac:    { id: 3, label: 'Air Conditioner' }
        };

        // Helpers
        function fmtUsage(sec){
        const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;
            if(h>0) return `${h}h ${m}m`;
            if(m>0) return `${m}m ${s}s`;
            return `${s}s`;
        }
        function setDeviceStatus(key, status){
            const span = document.getElementById(`status-${key}`);
            if(!span) return;
            span.innerText = status;
            span.classList.remove('on','off');
            span.classList.add(status==='ON'?'on':'off');
        }
        function setDeviceIcon(key, status) {
            const icon = document.getElementById(`icon-${key}`);
            if (!icon) return;

            const onClass = `${key}-on`;
            if (status === "ON") {
                icon.classList.add(onClass);
                if (key === "ac" && !icon.querySelector(".snow")) {
                icon.insertAdjacentHTML(
                    "beforeend",
                    '<span class="snow">❄</span><span class="snow delay">❄</span>'
                );
                }
            } else {
                icon.classList.remove(onClass);
                if (key === "ac") {
                icon.querySelectorAll(".snow").forEach((el) => el.remove());
                }
            }
        }
        function setLoading(key, isLoading) {
            const card = document.getElementById(`card-${key}`);
            if (!card) return;
            if (isLoading) {
                card.classList.add("loading");
            } else {
                card.classList.remove("loading");
            }
        }
        function getToggleInput(key){
        // tìm checkbox theo onchange chứa toggleDevice('<key>'
        return document.querySelector(`input[type="checkbox"][onchange*="toggleDevice('${key}'"]`);
        }

        /** =============================
         *  B) Cards cảm biến (top)
         *  ============================= */
        function updateSensorCards(row){
        if(!row) return;
        const t=Number(row.temp), h=Number(row.humid), l=Number(row.light);
        if(!isNaN(t)) document.getElementById('temp').innerText  = `${t.toFixed(1)}°C`;
        if(!isNaN(h)) document.getElementById('humid').innerText = `${h.toFixed(1)}%`;
        if(!isNaN(l)) document.getElementById('light').innerText = `${l.toFixed(1)} lux`;
        }

        /** =============================
         *  C) Chart thời gian thực
         *  ============================= */
        const ctx = document.getElementById('chartLine').getContext('2d');
        const lineChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
            { label:'Temperature (°C)', data:[], yAxisID:'y',  borderColor:'#ef4444', backgroundColor:'#ef4444', tension:0.3, pointRadius:0 },
            { label:'Humidity (%)',     data:[], yAxisID:'y',  borderColor:'#3b82f6', backgroundColor:'#3b82f6', tension:0.3, pointRadius:0 },
            { label:'Illuminance (lux)',data:[], yAxisID:'y1', borderColor:'#f59e0b', backgroundColor:'#f59e0b', tension:0.3, pointRadius:0 }
            ]
        },
        options: {
            responsive:true, maintainAspectRatio:false,
            interaction:{ mode:'nearest', intersect:false },
            scales:{
            x:{ type:'time', time:{ unit:'minute' }, ticks:{ maxRotation:0 } },
            y:{ position:'left', title:{ display:true, text:'Temp / Hum' }, min:0, max:100, grid:{ drawOnChartArea:true } },
            y1:{ position:'right', title:{ display:true, text:'Lux' }, min:0, grid:{ drawOnChartArea:false } } // <-- 65k lux
            },
            plugins:{
            legend:{ display:true },
            tooltip:{ callbacks:{ label:(ctx)=>{
                const label=ctx.dataset.label||'', v=ctx.parsed.y;
                if(label.includes('Temperature')) return `${label}: ${v.toFixed(1)} °C`;
                if(label.includes('Humidity'))    return `${label}: ${v.toFixed(0)} %`;
                if(label.includes('Illuminance')) return `${label}: ${v.toFixed(0)} lux`;
                return `${label}: ${v}`;
            }}}
            }
        }
        });

        // Thêm điểm vào chart
        function addPoint(tsISOorMs, temp, hum, lux, keep=300){
            const ts = typeof tsISOorMs==='string' ? new Date(tsISOorMs).getTime() : tsISOorMs;
            if(!isNaN(temp)) lineChart.data.datasets[0].data.push({x:ts,y:Number(temp)});
            if(!isNaN(hum))  lineChart.data.datasets[1].data.push({x:ts,y:Number(hum)});
            if(!isNaN(lux))  lineChart.data.datasets[2].data.push({x:ts,y:Number(lux)});
            lineChart.data.datasets.forEach(ds=>{ while(ds.data.length>keep) ds.data.shift(); });
            lineChart.update('none');
        }

        function removeOldestPoint(){
            lineChart.data.datasets.forEach(ds => {
                if (ds.data.length > 0) {
                    ds.data.shift(); // Xóa phần tử đầu tiên (cũ nhất)
                }
            });
            lineChart.update();
        }

        /** =============================
         *  D) Nạp dữ liệu ban đầu
         *  ============================= */
        (async function bootstrap(){
        // 1) Snapshot cảm biến mới nhất
        try{
            const r1 = await fetch('/api/sensors/latest',{
                headers:{
                    "Authorization": 'bearer 123456iottoken'
                }
            });
            const latest = await r1.json();
            if(latest && latest.temp!=null) updateSensorCards(latest);
        }catch(e){ console.warn('load latest sensors failed', e); }

        // 2) Lịch sử để vẽ chart (limit 200 gần nhất)
        try{
            const r2 = await fetch('/api/sensors?limit=400',{
                headers:{
                    "Authorization" : 'bearer 123456iottoken'
                }
            });
            const json = await r2.json();
            let history = Array.isArray(json) ? json : json.data || [];
            history.sort((a,b)=> new Date(a.measured_at) - new Date(b.measured_at));
            history.forEach(row=> addPoint(row.measured_at, row.temp, row.humid, row.light));

        }catch(e){ console.warn('load history failed', e); }

        // 3) Lấy danh sách thiết bị để đồng bộ trạng thái 3 công tắc
        try{
            const r3 = await fetch('/api/devices',{
                headers:{
                    "Authorization":' bearer 123456iottoken'
                }
            });
            const devices = await r3.json();
            const byId = {}; devices.forEach(d=> byId[d.id]=d);
            Object.entries(DEVICE_MAP).forEach(([key,{id}])=>{
            const dev = byId[id]; if(!dev) return;
            setDeviceStatus(key, dev.status);
            setDeviceIcon(key, dev.status);
            const input = getToggleInput(key);
            if(input) input.checked = dev.status==='ON';
            });
        }catch(e){ console.warn('load devices failed', e); }
        })();

        /** =============================
         *  E) Realtime từ backend (Socket.IO)
         *  ============================= */
        socket.on('sensors:new', (row)=>{
        updateSensorCards(row);
        addPoint(row.measured_at || Date.now(), row.temp, row.humid, row.light);
        removeOldestPoint();
        });

        /** =============================
         *  Lắng nghe ACK từ server
         *  ============================= */
        socket.on("devices:update", (dev) => {
        // tìm key trong DEVICE_MAP theo id
        const entry = Object.entries(DEVICE_MAP).find(([_, meta]) => meta.id === dev.id);
        if (!entry) return;
        const [key] = entry;

        // cập nhật UI chính xác theo ack
        setDeviceStatus(key, dev.status);
        setDeviceIcon(key, dev.status);
        setLoading(key, false);

        const input = getToggleInput(key);
        if (input) input.checked = dev.status === "ON";


        console.log("ACK cập nhật thiết bị:", dev);
        });

        /** =============================
         *  F) Toggle thiết bị từ Dashboard
         *  ============================= */
        async function toggleDevice(key, checkboxEl){
        const meta = DEVICE_MAP[key]; if(!meta) return;
        const status = checkboxEl.checked ? 'ON' : 'OFF';
        const toggleDeviceTimeouts = {};
        try{
            await fetch('/api/devices/toggle', {
            method:'POST',
            headers:{'Content-Type':'application/json',
                "Authorization": 'bearer 123456iottoken'
            },
            body: JSON.stringify({ id: meta.id, status })
            });
            // Tạm set UI (ACK về sẽ đồng bộ lại)
            //setDeviceStatus(key, status);
            // setDeviceIcon(key, status);
            setLoading(key, true);

            const timeoutId = setTimeout(() => {
                    setLoading(key, false);
                    alert('⚠️ Không nhận được phản hồi từ thiết bị!\nTrang sẽ được tải lại.');
                    location.reload();
                }, 10000);

                // Lưu timeout để hủy khi ACK về
                toggleDeviceTimeouts[key] = timeoutId;
        }catch(e){
            console.error('toggle failed', e);
            checkboxEl.checked = !checkboxEl.checked; // rollback
            alert('Toggle thất bại!');
        }
        }
    </script>



</body>
</html>