<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="assets/css/style.css">
    <title>IoT Dashboard - Device Monitoring & Control</title>
</head>
<body>
    <!-- SideBar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">IOT Dashboard</div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <span class="nav-icon"><i class="ri-home-7-line"></i></span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sensordata.html">
                    <span class="nav-icon"><i class="ri-sensor-line"></i></span>
                    <span>Sensor Data</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="devices.html">
                    <span class="nav-icon"><i class="ri-lightbulb-line"></i></span>
                    <span>Devices</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
     <div class="main-content">
        <!-- TopBar -->
        <div class="header">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
            <div class="profile-section" onclick="openProfileModal()">
                <div class="profile-avatar"><img src="assets/images/Anhthe.jpg" alt=""></div>
                <span class="profile-name">Nông Thanh Hải</span>
            </div>
        </div>
        <!-- Devices Page -->
        <div id="devices" class="page active">
            <!-- Device List -->
             <div class="dashboard-grid">
                <div class="card" id="card-light">
                    <div class="devicepage-card">
                        <div class="devicepage-info">
                            <h3>Light Bulb</h3>
                            <div class="devicepage-status off-status" id="status-light">OFF</div>
                        </div>
                        <div class="devicepage-icon"><i id="icon-light" class="bi bi-lightbulb-fill"></i></i></div>
                    </div>
                    <div class="data-stat">
                        <div class="data">
                            <span>Usage Time</span>
                            <span class="data-value" id="usage-light">2h 30m</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" onchange="toggleDevice('light', this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="card" id="card-fan">
                    <div class="devicepage-card">
                        <div class="devicepage-info">
                            <h3>Fan</h3>
                            <div class="devicepage-status off-status" id="status-fan" >OFF</div>
                        </div>
                        <div class="devicepage-icon"><i id="icon-fan" class="fa-solid fa-fan"></i></div>
                    </div>
                    <div class="data-stat">
                        <div class="data">
                            <span>Usage Time</span>
                            <span class="data-value" id="usage-fan">2h 30m</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" onchange="toggleDevice('fan', this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="card" id="card-ac">
                    <div class="devicepage-card">
                        <div class="devicepage-info">
                            <h3>Air Conditioner</h3>
                            <div class="devicepage-status on-status" id="status-ac">ON</div>
                        </div>
                        <div class="devicepage-icon"><i id="icon-ac" class="bi bi-snow2"></i></i></div>
                    </div>
                    <div class="data-stat">
                        <div class="data">
                            <span>Usage Time</span>
                            <span class="data-value" id="usage-ac">2h 30m</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" onchange="toggleDevice('ac', this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Search & Select -->
            <div class="search-selectbar">
                <div class="search">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search...">
                        <i class="bi bi-search search-icon"></i>
                    </div>
                    <div class="select-bar">
                        <select id="dataTypeSelect">
                            <option value="all">All</option>
                            <option value="time">Time</option>
                            <option value="device">Device</option>
                            <option value="status">Status</option>
                            <option value="actionbt">Action By</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="refresh-button">
                        <button class="btn" onclick="location.reload()" aria-label="Làm mới trang"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                    <div class="page-size">
                        <label for="pageSizeSelect">Rows per page:</label>
                        <select id="pageSizeSelect" onchange="changePageSize()">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="data-table" style="margin-top: 30px;">
                <div class="table-header">Device Aciton History</div>
                <table>
                    <thead>
                        <tr>
                            <th class="inactive" data-sort="time">Time</th>
                            <th class="inactive" data-sort="device">Device</th>
                            <th class="inactive" data-sort="status">Status</th>
                            <th class="inactive" data-sort="actionby">Action By</th>
                        </tr>
                    </thead>
                    <tbody id="DataTable">
                        <!-- <tr>
                            <td>25/8/2025 14:30:25</td>
                            <td>Light Bulb</td>
                            <td><span style="color: #10b981;">ON</span></td>
                            <td>User</td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
            <!-- Paginition -->
            <div class="table-footer">
                <div class="page-info" id="pageInfo">Hiển thị 1–10 / 0</div>

                <div class="pager">
                    <button class="btn" id="prevPage" aria-label="Trang trước">Prev</button>
                    <div id="pagination" class="pagination"></div>
                    <button class="btn" id="nextPage" aria-label="Trang sau">Next</button>
                </div>
            </div>
        </div>
    </div>
        <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Thông tin cá nhân</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="profile-modal-content">
                <div class="profile-modal-avatar"><img src="assets/images/Anhthe.jpg" alt=""></div>
                <div class="profile-info">
                    <h2>Nông Thanh Hải</h2>
                    <p><strong>Mã Sinh Viên:</strong> B22DCCN264</p>
                    <p><strong>CCCD:</strong> 019204000327</p>
                    <p><strong>Email:</strong> nthanhhai594@gmail.com</p>
                    <p><strong>Số điện thoại:</strong> 0969174272</p>
                </div>
                <div class="profile-links">
                    <a href="#"><img src="assets/images/github.jpg" onclick="alert('Updating')" alt=""></a>
                    <a href="#"><img src="assets/images/PDF.png" onclick="alert('Updating')" alt=""></a>
                    <a href="#"><img src="assets/images/apidoc.png" onclick="alert('Updating')" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/profilemodal.js"></script>

    <script src="assets/js/paginition.js">
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    const socket = io();

    // Map tên UI -> id thiết bị trong DB (seed: 1,2,3)
    const DEVICE_MAP = {
        light: { id: 1, label: 'Light Bulb' },
        fan:   { id: 2, label: 'Fan' },
        ac:    { id: 3, label: 'Air Conditioner' }
    };

    // Helpers
    function fmtUsage(sec){
        const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;
        if(h>0) return `${h}h ${m}m`;
        if(m>0) return `${m}m ${s}s`;
        return `${s}s`;
    }
    function setDeviceStatus(key, status){
        const span = document.getElementById(`status-${key}`);
        if(!span) return;
        span.innerText = status;
        span.classList.remove('on-status','off-status');
        span.classList.add(status==='ON'?'on-status':'off-status');
    }
    function setDeviceIcon(key, status) {
        const icon = document.getElementById(`icon-${key}`);
        if (!icon) return;

        const onClass = `${key}-on`;
        if (status === "ON") {
            icon.classList.add(onClass);
            if (key === "ac" && !icon.querySelector(".snow")) {
            icon.insertAdjacentHTML(
                "beforeend",
                '<span class="snow">❄</span><span class="snow delay">❄</span>'
            );
            }
        } else {
            icon.classList.remove(onClass);
            if (key === "ac") {
            icon.querySelectorAll(".snow").forEach((el) => el.remove());
            }
        }
    }
    function updateUsage(key, seconds) {
        const usageEl = document.getElementById(`usage-${key}`);
        if (usageEl) {
            usageEl.innerText = fmtUsage(seconds || 0);
        }
    }
    function setLoading(key, isLoading) {
        const card = document.getElementById(`card-${key}`);
        if (!card) return;
        if (isLoading) {
            card.classList.add("loading");
        } else {
            card.classList.remove("loading");
        }
    }
    const usageTimers = {};

    function startUsageTimer(key, dev) {
        stopUsageTimer(key); // clear timer cũ

        if (dev.status !== "ON") {
            updateUsage(key, dev.usage_seconds_today || 0);
            return;
        }

        const base = dev.usage_seconds_today || 0;
        const lastChanged = dev.last_state_changed_at 
            ? new Date(dev.last_state_changed_at).getTime() 
            : Date.now();

        function tick() {
            const now = Date.now();
            const extra = Math.floor((now - lastChanged) / 1000); 
            updateUsage(key, base + extra);

            usageTimers[key] = requestAnimationFrame(tick);
        }

        tick();
        }

        function stopUsageTimer(key) {
        if (usageTimers[key]) {
            cancelAnimationFrame(usageTimers[key]);
            usageTimers[key] = null;
        }
    }

    
    function getToggleInput(key){
        // tìm checkbox theo onchange chứa toggleDevice('<key>'
        return document.querySelector(`input[type="checkbox"][onchange*="toggleDevice('${key}'"]`);
    }

    /** =============================
     *  Toggle thiết bị từ Dashboard
     *  ============================= */
    async function toggleDevice(key, checkboxEl){
    const meta = DEVICE_MAP[key]; if(!meta) return;
    const status = checkboxEl.checked ? 'ON' : 'OFF';
    try{
        await fetch('/api/devices/toggle', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: meta.id, status })
        });
        setLoading(key, true);
        // Tạm set UI (ACK về sẽ đồng bộ lại)
        //setDeviceStatus(key, status);
        // setDeviceIcon(key, status);
    }catch(e){
        console.error('toggle failed', e);
        checkboxEl.checked = !checkboxEl.checked; // rollback
        alert('Toggle thất bại!');
    }
    }

    (async function bootstrap(){
    // 3) Lấy danh sách thiết bị để đồng bộ trạng thái 3 công tắc
    try{
        const r3 = await fetch('/api/devices');
        const devices = await r3.json();
        const byId = {}; devices.forEach(d=> byId[d.id]=d);
        Object.entries(DEVICE_MAP).forEach(([key,{id}])=>{
            const dev = byId[id]; if(!dev) return;
            setDeviceStatus(key, dev.status);
            setDeviceIcon(key, dev.status);
            updateUsage(key, dev.usage_seconds_today);
            const input = getToggleInput(key);
            if(input) input.checked = dev.status==='ON';
            if (dev.status === "ON") {
                startUsageTimer(key, dev);
            } else {
                stopUsageTimer(key);
                updateUsage(key, dev.usage_seconds_today || 0);
            }
        });
    }catch(e){ console.warn('load devices failed', e); }
    })();

    /** =============================
     *  Lắng nghe ACK từ server
     *  ============================= */
    socket.on("devices:update", (dev) => {
    // tìm key trong DEVICE_MAP theo id
    const entry = Object.entries(DEVICE_MAP).find(([_, meta]) => meta.id === dev.id);
    if (!entry) return;
    const [key] = entry;

    // cập nhật UI chính xác theo ack
    setDeviceStatus(key, dev.status);
    setDeviceIcon(key, dev.status);
    updateUsage(key, dev.usage_seconds_today);
    setLoading(key, false);
    loadActionHistory(); // reload lịch sử

    const input = getToggleInput(key);
    if (input) input.checked = dev.status === "ON";

    if (dev.status === "ON") {
        startUsageTimer(key, dev);
    } else {
        stopUsageTimer(key);
        updateUsage(key, dev.usage_seconds_today || 0); // dùng giá trị DB khi OFF
    }


    console.log("ACK cập nhật thiết bị:", dev);
    });

    /** ================================
    *  ACTION HISTORY SCRIPT
    *  ================================ */

    // DOM refs
    const historyTable     = document.querySelector(".data-table table"); // lấy table trong div data-table
    const historyTbody     = document.getElementById("DataTable"); // tbody
    const historySearch    = document.getElementById("searchInput");
    const historyField     = document.getElementById("dataTypeSelect");
    const historySearchBtn = document.querySelector(".search-icon"); // dùng icon search
    const historyPageSize  = document.getElementById("pageSizeSelect");

    // Render bảng
    function renderHistoryTable(rows = []) {
    historyTbody.innerHTML = rows.map(r => {
        const dt = new Date(r.time || Date.now());
        const deviceName = r.deviceName || r.device || `Device #${r.deviceId}`;
        const color = r.status === "ON" ? "#10b981" : "#ef4444";
        return `
        <tr>
            <td>${dt.toLocaleString()}</td>
            <td>${deviceName}</td>
            <td><span style="color:${color};font-weight:600">${r.status}</span></td>
            <td>${r.actionBy || "System"}</td>
        </tr>
        `;
    }).join("");

    if (typeof sensorPager !== "undefined" && sensorPager?.refresh) {
        sensorPager.refresh();
    }
    }

    // Load dữ liệu từ API
    async function loadActionHistory({
        search = "",
        field = "all",
        sort = "time",
        order = "desc",
        page = 1,
        limit = 50,
    } = {}) {
    try {
        const url = `/api/devices/action_history?search=${encodeURIComponent(
        search
        )}&field=${field}&sort=${sort}&order=${order}&page=${page}&limit=${limit}`;
        const res = await fetch(url);
        const rows = await res.json();
        renderHistoryTable(rows);
    } catch (err) {
        console.error("Load action history failed", err);
    }
    }

    // ========== Search / Filter ==========
    historySearch.addEventListener("keypress", e => {
    if (e.key === "Enter") {
        loadActionHistory({
        search: historySearch.value,
        field: historyField.value,
        });
    }
    });

    historySearchBtn.addEventListener("click", () => {
    loadActionHistory({
        search: historySearch.value,
        field: historyField.value,
    });
    });

    historyField.addEventListener("change", () => {
    loadActionHistory({
        search: historySearch.value,
        field: historyField.value,
    });
    });

    // ========== Page Size ==========
    historyPageSize.addEventListener("change", () => {
    if (typeof sensorPager !== "undefined" && sensorPager?.setRowsPerPage) {
        sensorPager.setRowsPerPage(Number(historyPageSize.value || 10));
    }
    });

    // ========== Sort khi click header ==========
    historyTable.querySelectorAll("thead th").forEach(th => {
    th.addEventListener("click", () => {
        const field = th.dataset.sort || "time";
        let newOrder;

        if (th.classList.contains("asc")) {
            resetHistorySort(th);
            th.classList.remove("asc");
            th.classList.add("desc");
            newOrder = "desc";
        } else if (th.classList.contains("desc")) {
            resetHistorySort(th);
            th.classList.remove("desc");
            th.classList.add("asc");
            newOrder = "asc";
        } else {
            resetHistorySort(th);
            th.classList.remove("inactive");
            th.classList.add("asc");
            newOrder = "asc";
        }

        loadActionHistory({
            search: historySearch.value,
            field: historyField.value,
            sort: field,
            order: newOrder,
        });
    });
    });

    function resetHistorySort(activeTh) {
    historyTable.querySelectorAll("thead th").forEach(col => {
        if (col !== activeTh) {
        col.classList.remove("asc", "desc");
        col.classList.add("inactive");
        }
    });
    }

    // ========== Initial load ==========
    loadActionHistory();

    
</script>


</body>
</html>