<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <title>IoT Dashboard - Device Monitoring & Control</title>
</head>
<body>
    <!-- SideBar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">IOT Dashboard</div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <span class="nav-icon"><i class="ri-home-7-line"></i></span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sensordata.html">
                    <span class="nav-icon"><i class="ri-sensor-line"></i></span>
                    <span>Sensor Data</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="devices.html">
                    <span class="nav-icon"><i class="ri-lightbulb-line"></i></span>
                    <span>Devices</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
     <div class="main-content">
        <!-- TopBar -->
        <div class="header">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
            <div class="profile-section" onclick="openProfileModal()">
                <div class="profile-avatar"><img src="assets/images/Anhthe.jpg" alt=""></div>
                <span class="profile-name">Nông Thanh Hải</span>
            </div>
        </div>
        <!-- Devices Page -->
        <div id="devices" class="page active">
            <!-- Device List -->
             <div class="dashboard-grid">
                <div class="card">
                    <div class="devicepage-card">
                        <div class="devicepage-info">
                            <h3>Light Bulb</h3>
                            <div class="devicepage-status off-status">OFF</div>
                        </div>
                        <div class="devicepage-icon"><i class="bi bi-lightbulb-fill"></i></i></div>
                    </div>
                    <div class="data-stat">
                        <div class="data">
                            <span>Usage Time</span>
                            <span class="data-value">2h 30m</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="card">
                    <div class="devicepage-card">
                        <div class="devicepage-info">
                            <h3>Fan</h3>
                            <div class="devicepage-status off-status">OFF</div>
                        </div>
                        <div class="devicepage-icon"><i class="bi bi-fan"></i></div>
                    </div>
                    <div class="data-stat">
                        <div class="data">
                            <span>Usage Time</span>
                            <span class="data-value">2h 30m</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="card">
                    <div class="devicepage-card">
                        <div class="devicepage-info">
                            <h3>Air Conditioner</h3>
                            <div class="devicepage-status on-status">ON</div>
                        </div>
                        <div class="devicepage-icon"><i class="bi bi-snow2"></i></i></div>
                    </div>
                    <div class="data-stat">
                        <div class="data">
                            <span>Usage Time</span>
                            <span class="data-value">2h 30m</span>
                        </div>
                    </div>
                    <div class="device-controls">
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Search & Select -->
            <div class="search-selectbar">
                <div class="search">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search...">
                        <i class="bi bi-search search-icon"></i>
                    </div>
                    <div class="select-bar">
                        <select id="dataTypeSelect">
                            <option value="all">All</option>
                            <option value="time">Time</option>
                            <option value="device">Device</option>
                            <option value="status">Status</option>
                            <option value="actionbt">Action By</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="refresh-button">
                        <button class="btn" onclick="location.reload()" aria-label="Làm mới trang"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                    <div class="page-size">
                        <label for="pageSizeSelect">Rows per page:</label>
                        <select id="pageSizeSelect" onchange="changePageSize()">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="data-table" style="margin-top: 30px;">
                <div class="table-header">Device Aciton History</div>
                <table>
                    <thead>
                        <tr>
                            <th class="inactive" data-sort="time">Time</th>
                            <th class="inactive" data-sort="device">Device</th>
                            <th class="inactive" data-sort="status">Status</th>
                            <th class="inactive" data-sort="actionby">Action By</th>
                        </tr>
                    </thead>
                    <tbody id="ActionHistoryTable">
                        <!-- <tr>
                            <td>25/8/2025 14:30:25</td>
                            <td>Light Bulb</td>
                            <td><span style="color: #10b981;">ON</span></td>
                            <td>User</td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
            <!-- Paginition -->
            <div class="table-footer">
                <div class="page-info" id="pageInfo">Hiển thị 1–10 / 0</div>

                <div class="pager">
                    <button class="btn" id="prevPage" aria-label="Trang trước">Prev</button>
                    <div id="pagination" class="pagination"></div>
                    <button class="btn" id="nextPage" aria-label="Trang sau">Next</button>
                </div>
            </div>
        </div>
    </div>
        <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Thông tin cá nhân</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="profile-modal-content">
                <div class="profile-modal-avatar"><img src="assets/images/Anhthe.jpg" alt=""></div>
                <div class="profile-info">
                    <h2>Nông Thanh Hải</h2>
                    <p><strong>Mã Sinh Viên:</strong> B22DCCN264</p>
                    <p><strong>CCCD:</strong> 019204000327</p>
                    <p><strong>Email:</strong> nthanhhai594@gmail.com</p>
                    <p><strong>Số điện thoại:</strong> 0969174272</p>
                </div>
                <div class="profile-links">
                    <a href="#"><img src="assets/images/github.jpg" onclick="alert('Updating')" alt=""></a>
                    <a href="#"><img src="assets/images/PDF.png" onclick="alert('Updating')" alt=""></a>
                    <a href="#"><img src="assets/images/apidoc.png" onclick="alert('Updating')" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/profilemodal.js"></script>

    <script src="assets/js/paginition.js">
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
/** ================================
 *  ACTION HISTORY SCRIPT
 *  ================================ */

// DOM refs
const historyTable     = document.querySelector(".data-table table"); // lấy table trong div data-table
const historyTbody     = document.getElementById("ActionHistoryTable"); // tbody
const historySearch    = document.getElementById("searchInput");
const historyField     = document.getElementById("dataTypeSelect");
const historySearchBtn = document.querySelector(".search-icon"); // dùng icon search
const historyPageSize  = document.getElementById("pageSizeSelect");

// Render bảng
function renderHistoryTable(rows = []) {
  historyTbody.innerHTML = rows.map(r => {
    const dt = new Date(r.time || Date.now());
    const deviceName = r.deviceName || r.device || `Device #${r.deviceId}`;
    const color = r.status === "ON" ? "#10b981" : "#ef4444";
    return `
      <tr>
        <td>${dt.toLocaleString()}</td>
        <td>${deviceName}</td>
        <td><span style="color:${color};font-weight:600">${r.status}</span></td>
        <td>${r.actionBy || "System"}</td>
      </tr>
    `;
  }).join("");

  if (typeof sensorPager !== "undefined" && sensorPager?.refresh) {
    sensorPager.refresh();
  }
}

// Load dữ liệu từ API
async function loadActionHistory({
  search = "",
  field = "all",
  sort = "time",
  order = "desc",
  page = 1,
  limit = 50,
} = {}) {
  try {
    const url = `/api/devices/action_history?search=${encodeURIComponent(
      search
    )}&field=${field}&sort=${sort}&order=${order}&page=${page}&limit=${limit}`;
    const res = await fetch(url);
    const rows = await res.json();
    renderHistoryTable(rows);
  } catch (err) {
    console.error("Load action history failed", err);
  }
}

// ========== Search / Filter ==========
historySearch.addEventListener("keypress", e => {
  if (e.key === "Enter") {
    loadActionHistory({
      search: historySearch.value,
      field: historyField.value,
    });
  }
});

historySearchBtn.addEventListener("click", () => {
  loadActionHistory({
    search: historySearch.value,
    field: historyField.value,
  });
});

historyField.addEventListener("change", () => {
  loadActionHistory({
    search: historySearch.value,
    field: historyField.value,
  });
});

// ========== Page Size ==========
historyPageSize.addEventListener("change", () => {
  if (typeof sensorPager !== "undefined" && sensorPager?.setRowsPerPage) {
    sensorPager.setRowsPerPage(Number(historyPageSize.value || 10));
  }
});

// ========== Sort khi click header ==========
historyTable.querySelectorAll("thead th").forEach(th => {
  th.addEventListener("click", () => {
    const field = th.dataset.sort || "time";
    let newOrder;

    if (th.classList.contains("asc")) {
      resetHistorySort(th);
      th.classList.remove("asc");
      th.classList.add("desc");
      newOrder = "desc";
    } else if (th.classList.contains("desc")) {
      resetHistorySort(th);
      th.classList.remove("desc");
      th.classList.add("asc");
      newOrder = "asc";
    } else {
      resetHistorySort(th);
      th.classList.remove("inactive");
      th.classList.add("asc");
      newOrder = "asc";
    }

    loadActionHistory({
      search: historySearch.value,
      field: historyField.value,
      sort: field,
      order: newOrder,
    });
  });
});

function resetHistorySort(activeTh) {
  historyTable.querySelectorAll("thead th").forEach(col => {
    if (col !== activeTh) {
      col.classList.remove("asc", "desc");
      col.classList.add("inactive");
    }
  });
}

// ========== Initial load ==========
loadActionHistory();
</script>


</body>
</html>